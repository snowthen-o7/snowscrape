openapi: 3.0.3

info:
  title: SnowScrape API
  version: 1.0.0
  description: |
    SnowScrape is a modern web scraping platform with no-code job creation, scheduled scraping,
    JavaScript rendering, and proxy rotation. This API powers the SnowScrape backend, deployed
    on AWS Lambda behind API Gateway.

    ## Authentication
    All endpoints (except `/health`) require a valid Clerk JWT bearer token in the
    `Authorization` header.

    ## Rate Limiting
    API Gateway enforces a burst limit of 200 concurrent requests and a sustained rate of
    100 requests per second.

    ## Response Compression
    Responses larger than 1 KB are automatically compressed by API Gateway.
  contact:
    name: SnowForge LLC
    url: https://snowscrape.alexdiaz.me
  license:
    name: Proprietary

servers:
  - url: http://localhost:3000/{stage}
    description: Local development
    variables:
      stage:
        default: dev
        enum: [dev]
  - url: https://{apiId}.execute-api.us-east-2.amazonaws.com/{stage}
    description: AWS API Gateway (stage-prefixed)
    variables:
      apiId:
        default: REPLACE_ME
        description: The API Gateway REST API ID
      stage:
        default: dev
        enum: [dev, staging, prod]

security:
  - BearerAuth: []

tags:
  - name: Jobs
    description: Create, read, update, delete, and manage scraping jobs
  - name: Job Actions
    description: Pause, resume, cancel, and refresh jobs
  - name: Crawls
    description: Access crawl history and details for a job
  - name: Results
    description: Download and preview scraped results
  - name: Templates
    description: Save and reuse job configurations
  - name: Webhooks
    description: Manage webhook subscriptions for job events
  - name: Scraper
    description: Visual scraper builder preview and test endpoints
  - name: Utilities
    description: URL validation, SFTP validation, and health checks

paths:
  # ===========================================================================
  # HEALTH
  # ===========================================================================
  /health:
    get:
      operationId: healthCheck
      tags: [Utilities]
      summary: Service health check
      description: |
        Tests connectivity to DynamoDB, S3, and SQS. Also reports health status
        to the SnowGlobe Observatory for centralized monitoring. No authentication
        required.
      security: []
      responses:
        "200":
          description: All subsystems healthy
          headers:
            Access-Control-Allow-Origin:
              $ref: "#/components/headers/CorsOrigin"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthCheckResponse"
              example:
                status: healthy
                timestamp: "2026-01-22T15:30:00Z"
                service: snowscrape-backend
                version: "1.0.0"
                checks:
                  dynamodb:
                    status: healthy
                  s3:
                    status: healthy
                  sqs:
                    status: healthy
        "503":
          description: One or more subsystems degraded or unhealthy
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthCheckResponse"

  # ===========================================================================
  # JOBS
  # ===========================================================================
  /jobs:
    post:
      operationId: createJob
      tags: [Jobs]
      summary: Create a new scraping job
      description: |
        Creates a new scraping job. Supports two source types:
        - **csv**: provide a `source` URL (HTTP/HTTPS/SFTP) pointing to a CSV file and a `file_mapping` configuration.
        - **direct_url**: provide a `url_template` with optional date/time variables (e.g. `{{date:Y-m-d}}`).
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateJobRequest"
      responses:
        "201":
          description: Job created successfully
          headers:
            Access-Control-Allow-Origin:
              $ref: "#/components/headers/CorsOrigin"
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Job created successfully
                  job_id:
                    type: string
                    format: uuid
                    example: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
                required: [message, job_id]
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"

  /jobs/status:
    get:
      operationId: getAllJobStatuses
      tags: [Jobs]
      summary: List all jobs for the authenticated user
      description: |
        Returns all jobs belonging to the authenticated user with pagination support.
        Jobs are filtered server-side so users only see their own data.
      parameters:
        - name: limit
          in: query
          description: Number of items to return (max 100)
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
        - name: last_key
          in: query
          description: Base64-encoded pagination key from a previous response
          schema:
            type: string
      responses:
        "200":
          description: List of jobs
          headers:
            Access-Control-Allow-Origin:
              $ref: "#/components/headers/CorsOrigin"
          content:
            application/json:
              schema:
                type: object
                properties:
                  jobs:
                    type: array
                    items:
                      $ref: "#/components/schemas/Job"
                  count:
                    type: integer
                    description: Number of jobs in this page
                    example: 5
                  last_key:
                    type: string
                    description: Base64-encoded pagination key for the next page (absent if no more pages)
                    example: "eyJqb2JfaWQiOiAiYWJjMTIzIn0="
                required: [jobs, count]
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"

  /jobs/{job_id}:
    get:
      operationId: getJobDetails
      tags: [Jobs]
      summary: Get job details
      description: Returns full details of a specific job. Verifies the authenticated user owns the job.
      parameters:
        - $ref: "#/components/parameters/JobId"
      responses:
        "200":
          description: Job details
          headers:
            Access-Control-Allow-Origin:
              $ref: "#/components/headers/CorsOrigin"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Job"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

    put:
      operationId: updateJob
      tags: [Jobs]
      summary: Update a job
      description: Updates an existing job configuration. Validates the request body and verifies ownership.
      parameters:
        - $ref: "#/components/parameters/JobId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateJobRequest"
      responses:
        "200":
          description: Job updated successfully
          headers:
            Access-Control-Allow-Origin:
              $ref: "#/components/headers/CorsOrigin"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SuccessMessageWithJobId"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

    delete:
      operationId: deleteJob
      tags: [Jobs]
      summary: Delete a job
      description: Deletes a job and all associated crawls. Verifies ownership before deletion.
      parameters:
        - $ref: "#/components/parameters/JobId"
      responses:
        "200":
          description: Job deleted successfully
          headers:
            Access-Control-Allow-Origin:
              $ref: "#/components/headers/CorsOrigin"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SuccessMessageWithJobId"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  # ===========================================================================
  # JOB ACTIONS
  # ===========================================================================
  /jobs/{job_id}/pause:
    patch:
      operationId: pauseJob
      tags: [Job Actions]
      summary: Pause a job
      description: Pauses a running or scheduled job. The job will not be picked up by the scheduler until resumed.
      parameters:
        - $ref: "#/components/parameters/JobId"
      responses:
        "200":
          description: Job paused successfully
          headers:
            Access-Control-Allow-Origin:
              $ref: "#/components/headers/CorsOrigin"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SuccessMessageWithJobId"
              example:
                message: Job paused successfully
                job_id: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"

  /jobs/{job_id}/resume:
    patch:
      operationId: resumeJob
      tags: [Job Actions]
      summary: Resume a paused job
      description: Resumes a previously paused job so it can be picked up by the scheduler again.
      parameters:
        - $ref: "#/components/parameters/JobId"
      responses:
        "200":
          description: Job resumed successfully
          headers:
            Access-Control-Allow-Origin:
              $ref: "#/components/headers/CorsOrigin"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SuccessMessageWithJobId"
              example:
                message: Job resumed successfully
                job_id: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"

  /jobs/{job_id}/cancel:
    patch:
      operationId: cancelJob
      tags: [Job Actions]
      summary: Cancel a job
      description: Cancels a running or queued job. If the job is currently being processed, it will be stopped.
      parameters:
        - $ref: "#/components/parameters/JobId"
      responses:
        "200":
          description: Job cancelled successfully
          headers:
            Access-Control-Allow-Origin:
              $ref: "#/components/headers/CorsOrigin"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SuccessMessageWithJobId"
              example:
                message: Job cancelled successfully
                job_id: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /jobs/{job_id}/refresh:
    post:
      operationId: refreshJob
      tags: [Job Actions]
      summary: Manually refresh / re-crawl a job
      description: |
        Triggers an immediate re-crawl for the specified job, bypassing the normal schedule.
        The job is re-enqueued to SQS for processing.
      parameters:
        - $ref: "#/components/parameters/JobId"
      responses:
        "200":
          description: Job refreshed successfully
          headers:
            Access-Control-Allow-Origin:
              $ref: "#/components/headers/CorsOrigin"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SuccessMessageWithJobId"
              example:
                message: Job refreshed successfully
                job_id: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"

  # ===========================================================================
  # CRAWLS
  # ===========================================================================
  /jobs/{job_id}/crawls:
    get:
      operationId: getJobCrawls
      tags: [Crawls]
      summary: List crawls for a job
      description: Returns all crawl records associated with a job. Verifies ownership of the parent job.
      parameters:
        - $ref: "#/components/parameters/JobId"
      responses:
        "200":
          description: List of crawls
          headers:
            Access-Control-Allow-Origin:
              $ref: "#/components/headers/CorsOrigin"
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/CrawlResult"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /jobs/{job_id}/crawls/{crawl_id}:
    get:
      operationId: getCrawlDetails
      tags: [Crawls]
      summary: Get crawl details
      description: Returns details for a specific crawl within a job. Verifies ownership of the parent job.
      parameters:
        - $ref: "#/components/parameters/JobId"
        - name: crawl_id
          in: path
          required: true
          description: The unique identifier of the crawl
          schema:
            type: string
      responses:
        "200":
          description: Crawl details
          headers:
            Access-Control-Allow-Origin:
              $ref: "#/components/headers/CorsOrigin"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CrawlResult"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"

  # ===========================================================================
  # RESULTS
  # ===========================================================================
  /jobs/{job_id}/download:
    get:
      operationId: downloadResults
      tags: [Results]
      summary: Download job results
      description: |
        Generates a pre-signed S3 URL for downloading job results in the requested format.
        Supported formats: JSON, CSV, XLSX, Parquet, SQL. Non-JSON formats are converted
        on-the-fly and cached on S3 for subsequent requests.
      parameters:
        - $ref: "#/components/parameters/JobId"
        - name: format
          in: query
          description: Output file format
          schema:
            type: string
            enum: [json, csv, xlsx, parquet, sql]
            default: json
        - name: flatten
          in: query
          description: Whether to flatten nested result rows
          schema:
            type: string
            enum: ["true", "false"]
            default: "false"
        - name: sql_table_name
          in: query
          description: Table name to use when format is `sql`
          schema:
            type: string
            default: scraped_data
      responses:
        "200":
          description: Pre-signed download URL
          headers:
            Access-Control-Allow-Origin:
              $ref: "#/components/headers/CorsOrigin"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DownloadResponse"
              example:
                download_url: "https://s3.us-east-2.amazonaws.com/..."
                expires_in: 3600
                format: json
                file_size_bytes: 102400
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /jobs/{job_id}/preview:
    get:
      operationId: previewResults
      tags: [Results]
      summary: Preview job results with pagination
      description: |
        Returns a paginated subset of job results for in-app preview. Fetches the
        JSON result file from S3 and slices it according to the requested page.
      parameters:
        - $ref: "#/components/parameters/JobId"
        - name: page
          in: query
          description: Page number (1-based)
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: page_size
          in: query
          description: Number of results per page (max 100)
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
      responses:
        "200":
          description: Paginated results preview
          headers:
            Access-Control-Allow-Origin:
              $ref: "#/components/headers/CorsOrigin"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PreviewResultsResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  # ===========================================================================
  # TEMPLATES
  # ===========================================================================
  /templates:
    post:
      operationId: createTemplate
      tags: [Templates]
      summary: Create a job template
      description: Saves a job configuration as a reusable template.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateTemplateRequest"
      responses:
        "201":
          description: Template created successfully
          headers:
            Access-Control-Allow-Origin:
              $ref: "#/components/headers/CorsOrigin"
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Template created successfully
                  template_id:
                    type: string
                    format: uuid
                  template:
                    $ref: "#/components/schemas/Template"
                required: [message, template_id, template]
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"

    get:
      operationId: listTemplates
      tags: [Templates]
      summary: List all templates
      description: Returns all templates belonging to the authenticated user, sorted by creation date (newest first).
      responses:
        "200":
          description: List of templates
          headers:
            Access-Control-Allow-Origin:
              $ref: "#/components/headers/CorsOrigin"
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Template"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"

  /templates/{template_id}:
    get:
      operationId: getTemplate
      tags: [Templates]
      summary: Get a template by ID
      description: |
        Returns the template details. Also updates the `last_used` timestamp.
        Verifies the authenticated user owns the template.
      parameters:
        - $ref: "#/components/parameters/TemplateId"
      responses:
        "200":
          description: Template details
          headers:
            Access-Control-Allow-Origin:
              $ref: "#/components/headers/CorsOrigin"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Template"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

    delete:
      operationId: deleteTemplate
      tags: [Templates]
      summary: Delete a template
      description: Permanently deletes a template. Verifies ownership before deletion.
      parameters:
        - $ref: "#/components/parameters/TemplateId"
      responses:
        "200":
          description: Template deleted successfully
          headers:
            Access-Control-Allow-Origin:
              $ref: "#/components/headers/CorsOrigin"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SuccessMessage"
              example:
                message: Template deleted successfully
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  # ===========================================================================
  # WEBHOOKS
  # ===========================================================================
  /webhooks:
    post:
      operationId: createWebhook
      tags: [Webhooks]
      summary: Create a webhook
      description: |
        Registers a new webhook endpoint. The webhook will receive HMAC-signed
        POST requests for the subscribed event types.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateWebhookRequest"
      responses:
        "201":
          description: Webhook created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Webhook created successfully
                  webhook:
                    $ref: "#/components/schemas/WebhookResponse"
                required: [message, webhook]
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"

    get:
      operationId: listWebhooks
      tags: [Webhooks]
      summary: List all webhooks
      description: Returns all webhooks registered by the authenticated user. The `secret` field is omitted from list responses.
      responses:
        "200":
          description: List of webhooks
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Webhook"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"

  /webhooks/{webhook_id}:
    delete:
      operationId: deleteWebhook
      tags: [Webhooks]
      summary: Delete (deactivate) a webhook
      description: |
        Soft-deletes a webhook by setting `active` to false. The webhook record is
        retained but will no longer receive deliveries.
      parameters:
        - $ref: "#/components/parameters/WebhookId"
      responses:
        "200":
          description: Webhook deleted successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SuccessMessage"
              example:
                message: Webhook deleted successfully
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /webhooks/{webhook_id}/test:
    post:
      operationId: testWebhook
      tags: [Webhooks]
      summary: Send a test event to a webhook
      description: Dispatches a `webhook.test` event to verify the webhook endpoint is reachable and correctly configured.
      parameters:
        - $ref: "#/components/parameters/WebhookId"
      responses:
        "200":
          description: Test webhook sent successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Test webhook sent successfully
                  payload:
                    type: object
                    description: The test payload that was sent
                    properties:
                      event:
                        type: string
                        example: webhook.test
                      webhook_id:
                        type: string
                        format: uuid
                      timestamp:
                        type: string
                        format: date-time
                      message:
                        type: string
                        example: This is a test webhook event from SnowScrape
                required: [message, payload]
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  # ===========================================================================
  # SCRAPER PREVIEW & TEST
  # ===========================================================================
  /scraper/preview:
    post:
      operationId: scraperPreview
      tags: [Scraper]
      summary: Preview a page for visual scraper builder
      description: |
        Fetches the target URL and returns a simplified DOM structure suitable for the
        visual scraper builder. Uses multi-tier scraping escalation if needed (plain HTTP,
        proxy, JS rendering).
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ScraperPreviewRequest"
      responses:
        "200":
          description: Page fetched and parsed successfully
          headers:
            Access-Control-Allow-Origin:
              $ref: "#/components/headers/CorsOrigin"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ScraperPreviewResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"

  /scraper/test:
    post:
      operationId: scraperTest
      tags: [Scraper]
      summary: Test extraction selectors on a URL
      description: |
        Fetches the target URL and runs the provided selectors (XPath, regex, JSONPath)
        against the page content, returning extraction results for each selector.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ScraperTestRequest"
      responses:
        "200":
          description: Extraction test results
          headers:
            Access-Control-Allow-Origin:
              $ref: "#/components/headers/CorsOrigin"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ScraperTestResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"

  /scraper/preview/async:
    post:
      operationId: scraperPreviewAsyncStart
      tags: [Scraper]
      summary: Start an asynchronous scraper preview
      description: |
        Initiates an asynchronous scraping operation for sites that may exceed the
        30-second API Gateway timeout. Returns a `task_id` immediately. The client
        should connect to the WebSocket API to receive progress updates and the
        final result.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ScraperPreviewRequest"
      responses:
        "202":
          description: Async scrape accepted
          headers:
            Access-Control-Allow-Origin:
              $ref: "#/components/headers/CorsOrigin"
          content:
            application/json:
              schema:
                type: object
                properties:
                  task_id:
                    type: string
                    format: uuid
                    description: Unique identifier for the async task
                    example: "d4e5f6a7-b8c9-0123-4567-890abcdef012"
                  status:
                    type: string
                    example: started
                required: [task_id, status]
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"

  # ===========================================================================
  # UTILITIES
  # ===========================================================================
  /validate-sftp-url:
    post:
      operationId: validateSftpUrl
      tags: [Utilities]
      summary: Validate an SFTP URL and detect CSV settings
      description: |
        Connects to the SFTP server specified in the URL, downloads the file, and
        auto-detects CSV settings (delimiter, enclosure, escape character, and column
        headers). Used during job creation to configure CSV file mapping.
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                sftp_url:
                  type: string
                  description: "Full SFTP URL with credentials (sftp://user:pass@host:port/path/to/file.csv)"
                  example: "sftp://user:password@sftp.example.com:22/data/urls.csv"
              required: [sftp_url]
      responses:
        "200":
          description: SFTP URL validated successfully
          headers:
            Access-Control-Allow-Origin:
              $ref: "#/components/headers/CorsOrigin"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SftpValidationResponse"
              example:
                message: SFTP URL validated successfully
                delimiter: ","
                enclosure: "\""
                escape: "\\"
                headers: ["url", "name", "category"]
        "400":
          description: Invalid SFTP URL or connection failed
          headers:
            Access-Control-Allow-Origin:
              $ref: "#/components/headers/CorsOrigin"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /preview-url:
    post:
      operationId: previewUrlVariables
      tags: [Utilities]
      summary: Preview URL template variable resolution
      description: |
        Resolves date/time variables in a URL template and returns the resolved URL
        along with metadata about the detected variables. Useful for testing URL
        templates before creating a job.

        Supported variable syntax:
        - `{{date}}` - current date in Y-m-d format
        - `{{date:Y-m-d}}` - date with custom PHP-style format
        - `{{date+1d:Y-m-d}}` - date with offset
        - `{{time:H_i}}` - current time
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/URLPreviewRequest"
      responses:
        "200":
          description: URL template resolved successfully
          headers:
            Access-Control-Allow-Origin:
              $ref: "#/components/headers/CorsOrigin"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/URLPreviewResponse"
              example:
                valid: true
                template: "https://example.com/data/{{date:Y-m-d}}.pdf"
                resolved: "https://example.com/data/2026-01-22.pdf"
                variables:
                  - type: date
                    offset: null
                    format: "Y-m-d"
                timezone: "America/New_York"
                resolved_at: "2026-01-22T15:30:00-05:00"
        "400":
          description: Invalid URL template
          headers:
            Access-Control-Allow-Origin:
              $ref: "#/components/headers/CorsOrigin"
          content:
            application/json:
              schema:
                type: object
                properties:
                  valid:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: "url_template is required"
        "500":
          $ref: "#/components/responses/InternalError"

# =============================================================================
# COMPONENTS
# =============================================================================
components:
  # ---------------------------------------------------------------------------
  # Security Schemes
  # ---------------------------------------------------------------------------
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        Clerk-issued JWT token. Obtain from the Clerk frontend SDK and pass in
        the `Authorization: Bearer <token>` header.

  # ---------------------------------------------------------------------------
  # Parameters
  # ---------------------------------------------------------------------------
  parameters:
    JobId:
      name: job_id
      in: path
      required: true
      description: The unique identifier of the job (UUID)
      schema:
        type: string
        format: uuid
        example: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"

    TemplateId:
      name: template_id
      in: path
      required: true
      description: The unique identifier of the template (UUID)
      schema:
        type: string
        format: uuid

    WebhookId:
      name: webhook_id
      in: path
      required: true
      description: The unique identifier of the webhook (UUID)
      schema:
        type: string
        format: uuid

  # ---------------------------------------------------------------------------
  # Headers
  # ---------------------------------------------------------------------------
  headers:
    CorsOrigin:
      description: Allowed CORS origin (stage-specific)
      schema:
        type: string
        example: "https://snowscrape.alexdiaz.me"

  # ---------------------------------------------------------------------------
  # Reusable Responses
  # ---------------------------------------------------------------------------
  responses:
    BadRequest:
      description: Validation error or malformed request
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            message: "Validation error: Job name must be a non-empty string"

    Unauthorized:
      description: Missing or invalid authentication token
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            message: "Unauthorized - No token provided"

    Forbidden:
      description: Authenticated user does not own the requested resource
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            message: "You do not have permission to access this job"

    NotFound:
      description: Requested resource not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            message: "Job not found"

    InternalError:
      description: Unexpected server error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            message: "Internal server error"

  # ---------------------------------------------------------------------------
  # Schemas
  # ---------------------------------------------------------------------------
  schemas:
    # ---- Generic ----
    Error:
      type: object
      properties:
        message:
          type: string
          description: Human-readable error message
        error:
          type: string
          description: Detailed error information (present in some 500 responses)
      required: [message]

    SuccessMessage:
      type: object
      properties:
        message:
          type: string
      required: [message]

    SuccessMessageWithJobId:
      type: object
      properties:
        message:
          type: string
        job_id:
          type: string
          format: uuid
      required: [message, job_id]

    # ---- Health ----
    HealthCheckResponse:
      type: object
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
          example: healthy
        timestamp:
          type: string
          format: date-time
        service:
          type: string
          example: snowscrape-backend
        version:
          type: string
          example: "1.0.0"
        checks:
          type: object
          properties:
            dynamodb:
              $ref: "#/components/schemas/ServiceCheck"
            s3:
              $ref: "#/components/schemas/ServiceCheck"
            sqs:
              $ref: "#/components/schemas/ServiceCheck"
      required: [status, timestamp, service, version, checks]

    ServiceCheck:
      type: object
      properties:
        status:
          type: string
          enum: [healthy, unhealthy]
        error:
          type: string
          description: Error message if unhealthy
      required: [status]

    # ---- File Mapping ----
    FileMapping:
      type: object
      description: Configuration for parsing CSV source files
      properties:
        delimiter:
          type: string
          description: Column delimiter character
          enum: [",", ";", "|", "\t", "\\t"]
          example: ","
        enclosure:
          type: string
          description: Text enclosure character
          enum: ["\"", "'", "none"]
          example: "\""
        escape:
          type: string
          description: Escape character
          enum: ["\\", "/", "\"", "'", "none"]
          example: "\\"
        url_column:
          oneOf:
            - type: string
              description: Column name containing URLs
            - type: integer
              description: Column index containing URLs (0-based)
          example: "url"
      required: [delimiter, enclosure, escape, url_column]

    # ---- Query ----
    Query:
      type: object
      description: A data extraction query (XPath, regex, JSONPath, or PDF)
      properties:
        name:
          type: string
          description: Unique name for this query (alphanumeric, underscore, hyphen only)
          pattern: "^[a-zA-Z0-9_-]+$"
          maxLength: 100
          example: "product_title"
        type:
          type: string
          description: Query type
          enum: [xpath, regex, jsonpath, pdf_text, pdf_table, pdf_metadata]
          example: xpath
        query:
          type: string
          description: |
            The selector expression. Required for xpath, regex, and jsonpath types.
            Optional for pdf_* types.
          maxLength: 1000
          example: "//h1[@class='title']/text()"
        join:
          type: boolean
          description: Whether to join multiple matches into a single string
          default: false
          example: false
        pdf_config:
          $ref: "#/components/schemas/PdfConfig"
      required: [name, type, query, join]

    PdfConfig:
      type: object
      description: Optional PDF-specific extraction settings
      properties:
        page_range:
          type: array
          description: "[start, end] page indices (0-based)"
          items:
            type: integer
          minItems: 2
          maxItems: 2
          example: [0, 5]
        table_index:
          type: integer
          description: Specific table index to extract
          example: 0
        flatten:
          type: boolean
          description: Flatten table rows to a list
          default: false

    # ---- Scheduling ----
    Scheduling:
      type: object
      description: Cron-like scheduling configuration
      properties:
        days:
          type: array
          description: "Days of the week to run. Use 'Every Day' for daily."
          items:
            type: string
            enum: [Monday, Tuesday, Wednesday, Thursday, Friday, Saturday, Sunday, Every Day]
          example: [Monday, Wednesday, Friday]
        hours:
          type: array
          description: "Hours of the day to run (0-23). Use 24 for 'Every Hour'."
          items:
            type: integer
            minimum: 0
            maximum: 24
          example: [9, 17]
        minutes:
          type: array
          description: "Minutes past the hour to run (multiples of 5, 0-55). Use 60 for 'Every Minute Check'."
          items:
            type: integer
            minimum: 0
            maximum: 60
          example: [0, 30]
      required: [days, hours, minutes]

    # ---- Proxy Config ----
    ProxyConfig:
      type: object
      description: Proxy rotation settings
      properties:
        enabled:
          type: boolean
          description: Whether to use proxy rotation
          example: false
        geo_targeting:
          type: string
          description: Geographic region for proxy selection
          enum: [us, eu, as, any]
          example: us
        rotation_strategy:
          type: string
          description: How to select proxies from the pool
          enum: [random, round-robin]
          example: random
        max_retries:
          type: integer
          description: Maximum retry attempts with different proxies
          minimum: 0
          example: 3
        fallback_to_direct:
          type: boolean
          description: Fall back to direct connection if all proxies fail
          example: true
      required: [enabled]

    # ---- Render Config ----
    RenderConfig:
      type: object
      description: JavaScript rendering settings
      properties:
        enabled:
          type: boolean
          description: Whether to use JavaScript rendering
          example: false
        wait_strategy:
          type: string
          description: Page load wait strategy
          enum: [load, domcontentloaded, networkidle]
          example: load
        wait_timeout_ms:
          type: integer
          description: Maximum time to wait for the page to load (ms)
          minimum: 1000
          maximum: 120000
          example: 30000
        wait_for_selector:
          type: string
          nullable: true
          description: CSS selector to wait for before considering the page loaded
          example: "#main-content"
        capture_screenshot:
          type: boolean
          description: Capture a screenshot of the rendered page
          example: false
        screenshot_full_page:
          type: boolean
          description: Capture full page screenshot vs viewport only
          example: false
        block_resources:
          type: array
          description: Resource types to block during rendering (e.g. images, fonts)
          items:
            type: string
          example: ["image", "font"]
        fallback_to_standard:
          type: boolean
          description: Fall back to standard HTTP if JS rendering fails
          example: true
      required: [enabled]

    # ---- Export Config ----
    ExportConfig:
      type: object
      description: Automated export settings
      properties:
        enabled:
          type: boolean
          example: false
        formats:
          type: array
          items:
            type: string
            enum: [json, csv, xlsx]
          example: [json, csv]
        destination:
          type: string
          enum: [s3, local, webhook]
          example: s3
        s3_bucket:
          type: string
          nullable: true
          description: Custom S3 bucket for export (defaults to platform bucket)
        webhook_url:
          type: string
          nullable: true
          description: URL to POST exported data to
        include_screenshots:
          type: boolean
          description: Include screenshots in the export package
          example: false
        compress:
          type: boolean
          description: Compress the export as a ZIP archive
          example: false
      required: [enabled]

    # ---- Notification Config ----
    NotificationConfig:
      type: object
      description: Job completion notification settings
      properties:
        enabled:
          type: boolean
          example: false
        email_on_success:
          type: boolean
          example: true
        email_on_failure:
          type: boolean
          example: true
        email_addresses:
          type: array
          items:
            type: string
            format: email
          example: ["user@example.com"]
        webhook_on_success:
          type: boolean
          example: false
        webhook_on_failure:
          type: boolean
          example: false
        webhook_url:
          type: string
          nullable: true
      required: [enabled]

    # ---- Job (Create Request) ----
    CreateJobRequest:
      type: object
      description: |
        Request body for creating or updating a job. Supports two source types:
        - `csv`: requires `source` and `file_mapping`
        - `direct_url`: requires `url_template`
      properties:
        name:
          type: string
          description: Human-readable job name
          maxLength: 200
          example: "Daily Product Prices"
        source_type:
          type: string
          description: Source type for URLs
          enum: [csv, direct_url]
          default: csv
          example: csv
        source:
          type: string
          description: "URL to a CSV file (HTTP, HTTPS, or SFTP). Required when source_type is 'csv'."
          maxLength: 2048
          example: "https://example.com/urls.csv"
        url_template:
          type: string
          description: "URL template with optional date/time variables. Required when source_type is 'direct_url'."
          maxLength: 2048
          example: "https://example.com/data/{{date:Y-m-d}}.pdf"
        timezone:
          type: string
          description: "IANA timezone for variable resolution (only for direct_url mode)"
          default: UTC
          example: "America/New_York"
        file_mapping:
          $ref: "#/components/schemas/FileMapping"
        scheduling:
          $ref: "#/components/schemas/Scheduling"
        queries:
          type: array
          description: List of extraction queries (1-50)
          items:
            $ref: "#/components/schemas/Query"
          minItems: 1
          maxItems: 50
        rate_limit:
          type: integer
          description: Maximum concurrent requests per second (1-8)
          minimum: 1
          maximum: 8
          example: 2
        proxy_config:
          $ref: "#/components/schemas/ProxyConfig"
        render_config:
          $ref: "#/components/schemas/RenderConfig"
        export_config:
          $ref: "#/components/schemas/ExportConfig"
        notification_config:
          $ref: "#/components/schemas/NotificationConfig"
      required: [name, queries, rate_limit]

    # ---- Job (Response) ----
    Job:
      type: object
      description: Full job record as stored in DynamoDB
      properties:
        job_id:
          type: string
          format: uuid
          example: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
        user_id:
          type: string
          description: Clerk user ID
          example: "user_2abc123def456"
        name:
          type: string
          example: "Daily Product Prices"
        status:
          type: string
          description: Current job status
          enum: [ready, queued, processing, paused, cancelled, error, timeout]
          example: ready
        source_type:
          type: string
          enum: [csv, direct_url]
          example: csv
        source:
          type: string
          description: CSV source URL (only for csv source_type)
          example: "https://example.com/urls.csv"
        url_template:
          type: string
          description: URL template (only for direct_url source_type)
        timezone:
          type: string
          description: IANA timezone (only for direct_url source_type)
        file_mapping:
          $ref: "#/components/schemas/FileMapping"
        queries:
          type: array
          items:
            $ref: "#/components/schemas/Query"
        scheduling:
          $ref: "#/components/schemas/Scheduling"
        rate_limit:
          type: integer
          minimum: 1
          maximum: 8
          example: 2
        link_count:
          type: integer
          description: Number of URLs in this job
          example: 150
        created_at:
          type: string
          format: date-time
          example: "2026-01-15T10:30:00Z"
        last_run:
          type: string
          format: date-time
          description: Timestamp of the last crawl execution
          example: "2026-01-22T09:00:00Z"
        results_s3_key:
          type: string
          description: S3 key where the latest results are stored
          example: "jobs/a1b2c3d4/result.json"
        proxy_config:
          $ref: "#/components/schemas/ProxyConfig"
        render_config:
          $ref: "#/components/schemas/RenderConfig"
        export_config:
          $ref: "#/components/schemas/ExportConfig"
        notification_config:
          $ref: "#/components/schemas/NotificationConfig"
      required: [job_id, user_id, name, status, queries, rate_limit, link_count, created_at]

    # ---- Crawl Result ----
    CrawlResult:
      type: object
      description: A single crawl execution record for a URL within a job
      properties:
        job_id:
          type: string
          format: uuid
        url:
          type: string
          format: uri
          example: "https://example.com/page1"
        status:
          type: string
          description: Crawl status for this URL
          enum: [pending, finished, error, skipped]
          example: finished
        state:
          type: string
          description: Alias for status in some responses
        last_updated:
          type: string
          format: date-time
        results:
          type: object
          description: Extracted data keyed by query name
          additionalProperties:
            oneOf:
              - type: string
              - type: array
                items:
                  type: string
          example:
            product_title: "Widget Pro"
            price: "$29.99"
        error:
          type: string
          description: Error message if crawl failed

    # ---- Template ----
    CreateTemplateRequest:
      type: object
      properties:
        name:
          type: string
          description: Template name
          example: "E-commerce Price Scraper"
        description:
          type: string
          description: Optional description
          example: "Extracts product titles and prices from e-commerce sites"
        config:
          type: object
          description: Job configuration to save as a template
          properties:
            file_mapping:
              $ref: "#/components/schemas/FileMapping"
            queries:
              type: array
              items:
                $ref: "#/components/schemas/Query"
            scheduling:
              $ref: "#/components/schemas/Scheduling"
          required: [queries, scheduling]
      required: [name, config]

    Template:
      type: object
      properties:
        template_id:
          type: string
          format: uuid
          example: "t1a2b3c4-d5e6-7890-fghi-jk1234567890"
        user_id:
          type: string
          example: "user_2abc123def456"
        name:
          type: string
          example: "E-commerce Price Scraper"
        description:
          type: string
          example: "Extracts product titles and prices"
        config:
          type: object
          properties:
            file_mapping:
              $ref: "#/components/schemas/FileMapping"
            queries:
              type: array
              items:
                $ref: "#/components/schemas/Query"
            scheduling:
              $ref: "#/components/schemas/Scheduling"
        created_at:
          type: string
          format: date-time
        last_used:
          type: string
          format: date-time
          nullable: true
      required: [template_id, user_id, name, config, created_at]

    # ---- Webhook ----
    CreateWebhookRequest:
      type: object
      properties:
        url:
          type: string
          format: uri
          description: The endpoint URL that will receive webhook POST requests
          example: "https://myapp.example.com/webhooks/snowscrape"
        events:
          type: array
          description: Event types to subscribe to
          items:
            type: string
            enum: [job.created, job.started, job.completed, job.failed, job.cancelled]
          minItems: 1
          example: [job.completed, job.failed]
        job_id:
          type: string
          format: uuid
          description: Optional job ID to scope the webhook to a specific job
          nullable: true
      required: [url, events]

    Webhook:
      type: object
      description: Webhook subscription (list view, secret omitted)
      properties:
        webhook_id:
          type: string
          format: uuid
          example: "w1a2b3c4-d5e6-7890-fghi-jk1234567890"
        url:
          type: string
          format: uri
        events:
          type: array
          items:
            type: string
        active:
          type: boolean
          example: true
        created_at:
          type: string
          format: date-time
        total_deliveries:
          type: integer
          example: 42
        failed_deliveries:
          type: integer
          example: 2
        job_id:
          type: string
          format: uuid
          nullable: true
      required: [webhook_id, url, events, active, created_at, total_deliveries, failed_deliveries]

    WebhookResponse:
      type: object
      description: Webhook details returned on creation (includes secret)
      properties:
        webhook_id:
          type: string
          format: uuid
        url:
          type: string
          format: uri
        events:
          type: array
          items:
            type: string
        secret:
          type: string
          description: HMAC signing secret. Store securely -- it is only shown once at creation time.
          example: "f47ac10b-58cc-4372-a567-0e02b2c3d479"
        active:
          type: boolean
        created_at:
          type: string
          format: date-time
      required: [webhook_id, url, events, secret, active, created_at]

    # ---- Download / Preview ----
    DownloadResponse:
      type: object
      properties:
        download_url:
          type: string
          format: uri
          description: Pre-signed S3 URL (valid for 1 hour)
        expires_in:
          type: integer
          description: URL expiration time in seconds
          example: 3600
        format:
          type: string
          enum: [json, csv, xlsx, parquet, sql]
        file_size_bytes:
          type: integer
          description: File size in bytes
          example: 102400
      required: [download_url, expires_in, format, file_size_bytes]

    PreviewResultsResponse:
      type: object
      properties:
        results:
          type: array
          description: Paginated result rows
          items:
            type: object
            additionalProperties: true
        pagination:
          type: object
          properties:
            page:
              type: integer
              example: 1
            page_size:
              type: integer
              example: 50
            total_count:
              type: integer
              example: 245
            total_pages:
              type: integer
              example: 5
            has_next:
              type: boolean
              example: true
            has_previous:
              type: boolean
              example: false
          required: [page, page_size, total_count, total_pages, has_next, has_previous]
        columns:
          type: array
          description: Column names derived from the first result row
          items:
            type: string
          example: ["url", "product_title", "price"]
      required: [results, pagination, columns]

    # ---- URL Preview ----
    URLPreviewRequest:
      type: object
      properties:
        url_template:
          type: string
          description: URL template with optional date/time variables
          example: "https://example.com/data/{{date:Y-m-d}}.pdf"
        timezone:
          type: string
          description: IANA timezone for variable resolution
          default: UTC
          example: "America/New_York"
      required: [url_template]

    URLPreviewResponse:
      type: object
      properties:
        valid:
          type: boolean
          example: true
        error:
          type: string
          nullable: true
          description: Error message if the template is invalid
        template:
          type: string
          description: The original URL template
        resolved:
          type: string
          nullable: true
          description: The fully resolved URL with variables replaced
        variables:
          type: array
          description: Detected variables in the template
          items:
            $ref: "#/components/schemas/URLVariable"
        timezone:
          type: string
          description: The timezone used for resolution
        resolved_at:
          type: string
          format: date-time
          description: Timestamp when the URL was resolved
      required: [valid, template]

    URLVariable:
      type: object
      properties:
        type:
          type: string
          enum: [date, time]
          example: date
        offset:
          type: string
          nullable: true
          description: "Offset expression (e.g. '+1d', '-2h')"
          example: null
        format:
          type: string
          nullable: true
          description: "PHP-style format string (e.g. 'Y-m-d')"
          example: "Y-m-d"

    # ---- SFTP Validation ----
    SftpValidationResponse:
      type: object
      properties:
        message:
          type: string
          example: SFTP URL validated successfully
        delimiter:
          type: string
          example: ","
        enclosure:
          type: string
          example: "\""
        escape:
          type: string
          example: "\\"
        headers:
          type: array
          description: Detected column headers from the CSV file
          items:
            type: string
          example: ["url", "name", "category"]
      required: [message, delimiter, enclosure, escape, headers]

    # ---- Scraper Preview / Test ----
    ScraperPreviewRequest:
      type: object
      properties:
        url:
          type: string
          format: uri
          description: Target URL to fetch and parse
          example: "https://example.com/products"
      required: [url]

    ScraperPreviewResponse:
      type: object
      description: Simplified DOM structure for the visual scraper builder
      properties:
        elements:
          type: array
          description: Parsed DOM elements
          items:
            type: object
            properties:
              tag:
                type: string
                example: div
              xpath:
                type: string
                example: "/html/body/div[1]"
              text:
                type: string
              attributes:
                type: object
                additionalProperties:
                  type: string
              children:
                type: array
                items:
                  type: object
        url:
          type: string
          format: uri
          description: The URL that was fetched
        title:
          type: string
          description: Page title
        tier_used:
          type: integer
          description: Scraping tier that successfully fetched the page (1-4)
          example: 1
      required: [elements, url]

    ScraperTestRequest:
      type: object
      properties:
        url:
          type: string
          format: uri
          description: Target URL to test selectors against
          example: "https://example.com/products"
        selectors:
          type: array
          description: List of selector objects to test
          items:
            type: object
            properties:
              name:
                type: string
                example: title
              type:
                type: string
                enum: [xpath, regex, jsonpath, css]
                example: xpath
              selector:
                type: string
                example: "//h1/text()"
            required: [name, type, selector]
          minItems: 1
      required: [url, selectors]

    ScraperTestResponse:
      type: object
      description: Extraction test results for each selector
      additionalProperties:
        type: object
        properties:
          matches:
            type: array
            items:
              type: string
          count:
            type: integer
          error:
            type: string
            nullable: true
